<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DSGL Wasm Gallery</title>
    <style>
      body {
        background: #222;
        color: #eee;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
      }
      h1 {
        margin-bottom: 30px;
      }
      .gallery {
        display: flex;
        gap: 40px;
        flex-wrap: wrap;
        justify-content: center;
        flex-direction: column;
      }
      .artwork {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .artwork h2 {
        margin-bottom: 10px;
        font-weight: lighter;
      }
      canvas {
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        background: #000;
        height: auto;
        max-width: 100%;
      }
      .controls {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: center;
      }
      input[type='text'],
      select {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #555;
        background: #333;
        color: white;
        font-family: monospace;
      }
      select {
        cursor: pointer;
      }
      label {
        font-size: 0.9rem;
        color: #aaa;
        margin-left: 5px;
      }
      .hint {
        margin-top: 10px;
        font-size: 0.8rem;
        color: #ccc;
        background: #333;
        padding: 10px;
        border-radius: 4px;
        line-height: 1.5;
        max-width: 100%;
      }
      .hint code {
        background: #555;
        padding: 2px 5px;
        border-radius: 3px;
        color: #fff;
        font-family: monospace;
      }
      .hint-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 5px;
        margin-top: 5px;
        font-size: 0.75rem;
      }
      .hint-grid span {
        background: #444;
        text-align: center;
        padding: 2px;
        border-radius: 2px;
      }
    </style>
  </head>
  <body>
    <h1>DSGL WebAssembly Gallery</h1>
    <div class="gallery">
      <div class="artwork">
        <h2>Code-128 Generator</h2>
        <canvas id="barcode-canvas"></canvas>
        <div class="controls">
          <input
            type="text"
            id="barcode-input"
            value=""
            placeholder="Enter text..."
            oninput="renderBarcode()"
          />
          <label for="dpr-input">Scale:</label>
          <select id="dpr-input" onchange="renderBarcode()">
            <option value="1">1x</option>
            <option value="2">2x</option>
            <option value="3">3x</option>
            <option value="4">4x</option>
          </select>
        </div>
        <div class="hint">
          <strong>Usage:</strong> Supports Subsets A, B, C.<br />
          The encoder automatically optimizes subsets Shifting and Latching.<br />
          Use <code>^KEY</code> for Control Characters or FNC codes.<br />
          <br />
          <strong>Supported Escape Codes:</strong>
          <div class="hint-grid">
            <span>^NUL</span><span>^SOH</span><span>^STX</span><span>^ETX</span
            ><span>^EOT</span><span>^ENQ</span><span>^ACK</span><span>^BEL</span
            ><span>^BS</span><span>^HT</span><span>^LF</span><span>^VT</span
            ><span>^FF</span><span>^CR</span><span>^SO</span><span>^SI</span
            ><span>^DLE</span><span>^DC1</span><span>^DC2</span><span>^DC3</span
            ><span>^DC4</span><span>^NAK</span><span>^SYN</span><span>^ETB</span
            ><span>^CAN</span><span>^EM</span><span>^SUB</span><span>^ESC</span
            ><span>^FS</span><span>^GS</span><span>^RS</span><span>^US</span
            ><span>^DEL</span><span>^FNC1</span><span>^FNC2</span
            ><span>^FNC3</span> <span>^FNC4</span>
          </div>
          <br />
          <em
            >Note: <code>^ABC</code> will be treated as literal text unless it
            matches a code above.</em
          >
        </div>
      </div>
      <div class="artwork">
        <h2>Mondrian</h2>
        <canvas id="mondrian-canvas" width="600" height="600"></canvas>
      </div>
      <div class="artwork">
        <h2>Patterns Negative</h2>
        <canvas id="patterns-canvas" width="800" height="600"></canvas>
      </div>
    </div>
    <script>
      async function loadWasmImage(wasmPath, canvasId, width, height) {
        try {
          const response = await fetch(wasmPath);
          if (!response.ok) throw new Error(response.status);
          const bytes = await response.arrayBuffer();
          const { instance } = await WebAssembly.instantiate(bytes, {});
          instance.exports.render();
          const pixelsPtr = instance.exports.pixels.value;
          const wasmMem = instance.exports.memory;
          const memArr = new Uint8ClampedArray(
            wasmMem.buffer,
            pixelsPtr,
            width * height * 4,
          );
          const canvas = document.getElementById(canvasId);
          const ctx = canvas.getContext('2d');
          const imgData = new ImageData(memArr, width, height);
          ctx.putImageData(imgData, 0, 0);
          console.log(`Loaded ${wasmPath}`);
        } catch (err) {
          console.error(`Failed to load ${wasmPath}:`, err);
        }
      }
      let barcodeModule = null;
      async function initBarcode() {
        try {
          const response = await fetch('examples/to_wasm/barcode_128.wasm');
          if (!response.ok) throw new Error(response.status);
          const bytes = await response.arrayBuffer();
          const { instance } = await WebAssembly.instantiate(bytes, {});
          barcodeModule = instance.exports;
          const maxLen = barcodeModule.get_max_input_length();
          const inputEl = document.getElementById('barcode-input');
          inputEl.maxLength = maxLen;
          inputEl.title = `Max buffer: ${maxLen} chars`;
          const dpr = window.devicePixelRatio || 1;
          const roundedDpr = Math.ceil(dpr);
          const dprSelect = document.getElementById('dpr-input');
          dprSelect.value = Math.min(roundedDpr, 4);
          renderBarcode();
          console.log('Barcode module initialized.');
        } catch (err) {
          console.error('Failed to load barcode.wasm', err);
        }
      }
      function renderBarcode() {
        const inputEl = document.getElementById('barcode-input');
        const dprEl = document.getElementById('dpr-input');
        const scale = +dprEl.value;
        barcodeModule.set_dpr(scale);
        const text = inputEl.value;
        const inputPtr = barcodeModule.get_data_buffer();
        const memBuffer = barcodeModule.memory.buffer;
        const wasmMem = new Uint8Array(memBuffer);
        for (let i = 0; i < text.length; i++) {
          wasmMem[inputPtr + i] = text.charCodeAt(i);
        }
        wasmMem[inputPtr + text.length] = 0;
        barcodeModule.render();
        const width = barcodeModule.get_width();
        const height = barcodeModule.get_height();
        const canvas = document.getElementById('barcode-canvas');
        canvas.width = width;
        canvas.height = height;
        canvas.style.width = `${width / scale}px`;
        const pixelPtr = barcodeModule.get_pixel_buffer();
        const pixelData = new Uint8ClampedArray(
          memBuffer,
          pixelPtr,
          width * height * 4,
        );
        const ctx = canvas.getContext('2d');
        const imageData = new ImageData(pixelData, width, height);
        ctx.putImageData(imageData, 0, 0);
      }
      loadWasmImage(
        'examples/to_wasm/mondrian.wasm',
        'mondrian-canvas',
        600,
        600,
      );
      loadWasmImage(
        'examples/to_wasm/patterns_negative.wasm',
        'patterns-canvas',
        800,
        600,
      );
      initBarcode();
    </script>
  </body>
</html>
