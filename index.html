<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DSGL Wasm Gallery</title>
    <style>
      body {
        background: #222;
        color: #eee;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
      }
      h1 {
        margin-bottom: 30px;
      }
      .gallery {
        display: flex;
        gap: 40px;
        flex-wrap: wrap;
        justify-content: center;
        flex-direction: column;
      }
      .artwork {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .artwork h2 {
        margin-bottom: 10px;
        font-weight: lighter;
      }
      canvas {
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        background: #000;
        height: auto;
        max-width: 100%;
      }
      .controls {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        align-items: center;
      }
      input[type='text'],
      select {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #555;
        background: #333;
        color: white;
        font-family: monospace;
      }
      select {
        cursor: pointer;
      }
      label {
        font-size: 0.9rem;
        color: #aaa;
        margin-left: 5px;
      }
    </style>
  </head>
  <body>
    <h1>DSGL WebAssembly Gallery</h1>
    <div class="gallery">
      <div class="artwork">
        <h2>Code-128 Generator</h2>
        <canvas id="barcode-canvas"></canvas>
        <div class="controls">
          <input
            type="text"
            id="barcode-input"
            value="(421) 032"
            placeholder="Enter text..."
            oninput="renderBarcode()"
          />
          <label for="dpr-input">Scale:</label>
          <select id="dpr-input" onchange="renderBarcode()">
            <option value="1">1x</option>
            <option value="2">2x</option>
            <option value="4">4x</option>
          </select>
        </div>
      </div>
      <div class="artwork">
        <h2>Mondrian</h2>
        <canvas id="mondrian-canvas" width="600" height="600"></canvas>
      </div>
      <div class="artwork">
        <h2>Patterns Negative</h2>
        <canvas id="patterns-canvas" width="800" height="600"></canvas>
      </div>
    </div>
    <script>
      async function loadWasmImage(wasmPath, canvasId, width, height) {
        try {
          const memory = new WebAssembly.Memory({ initial: 80 });
          const imports = { env: { memory: memory } };
          const response = await fetch(wasmPath);
          if (!response.ok) throw new Error(response.status);
          const bytes = await response.arrayBuffer();
          const { instance } = await WebAssembly.instantiate(bytes, imports);
          instance.exports.render();
          const pixelsPtr = instance.exports.pixels.value;
          const wasmMem = instance.exports.memory || memory;
          const memArr = new Uint8ClampedArray(
            wasmMem.buffer,
            pixelsPtr,
            width * height * 4,
          );
          const canvas = document.getElementById(canvasId);
          const ctx = canvas.getContext('2d');
          const imgData = new ImageData(memArr, width, height);
          ctx.putImageData(imgData, 0, 0);
          console.log(`Loaded ${wasmPath}`);
        } catch (err) {
          console.error(`Failed to load ${wasmPath}:`, err);
        }
      }
      let barcodeModule = null;
      async function initBarcode() {
        try {
          const response = await fetch('examples/to_wasm/barcode_128.wasm');
          if (!response.ok) throw new Error(response.status);
          const bytes = await response.arrayBuffer();
          const { instance } = await WebAssembly.instantiate(bytes, {});
          barcodeModule = instance.exports;
          if (barcodeModule.get_max_input_length) {
            const maxLen = barcodeModule.get_max_input_length();
            const inputEl = document.getElementById('barcode-input');
            inputEl.maxLength = maxLen;
            inputEl.title = `Max characters: ${maxLen}`;
          }
          const dpr = window.devicePixelRatio || 1;
          const roundedDpr = Math.ceil(dpr);
          const dprSelect = document.getElementById('dpr-input');
          if (roundedDpr >= 1 && roundedDpr <= 4) {
            dprSelect.value = roundedDpr;
          } else if (roundedDpr > 4) {
            dprSelect.value = 1;
          }
          renderBarcode();
          console.log('Barcode module initialized.');
        } catch (err) {
          console.error('Failed to load barcode.wasm', err);
        }
      }
      function renderBarcode() {
        if (!barcodeModule) return;
        const inputEl = document.getElementById('barcode-input');
        const dprEl = document.getElementById('dpr-input');
        const scale = parseInt(dprEl.value, 10) || 1;
        if (barcodeModule.set_dpr) {
          barcodeModule.set_dpr(scale);
        }
        const text = inputEl.value;
        const inputPtr = barcodeModule.get_data_buffer();
        const wasmMem = new Uint8Array(barcodeModule.memory.buffer);
        for (let i = 0; i < text.length; i++) {
          wasmMem[inputPtr + i] = text.charCodeAt(i);
        }
        wasmMem[inputPtr + text.length] = 0;
        barcodeModule.render();
        const width = barcodeModule.get_width();
        const height = barcodeModule.get_height();
        if (width <= 0 || height <= 0) {
          console.warn('Barcode invalid or too large.');
          return;
        }
        const canvas = document.getElementById('barcode-canvas');
        canvas.width = width;
        canvas.height = height;
        canvas.style.width = `${width / scale}px`;
        const pixelPtr = barcodeModule.get_pixel_buffer();
        const pixelData = new Uint8ClampedArray(
          barcodeModule.memory.buffer,
          pixelPtr,
          width * height * 4,
        );
        const ctx = canvas.getContext('2d');
        const imageData = new ImageData(pixelData, width, height);
        ctx.putImageData(imageData, 0, 0);
      }
      loadWasmImage(
        'examples/to_wasm/mondrian.wasm',
        'mondrian-canvas',
        600,
        600,
      );
      loadWasmImage(
        'examples/to_wasm/patterns_negative.wasm',
        'patterns-canvas',
        800,
        600,
      );
      initBarcode();
    </script>
  </body>
</html>
